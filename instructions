Galaxy Offline Installation (RHEL 9) ‚Äì Complete Start-to-Finish Guide

Below is a clean, start-to-finish, battle-tested guide for installing Galaxy on RHEL 9 with an online build VM and an air-gapped offline VM, ending with Galaxy running as a systemd service offline (no user intervention).
This version includes the real gotchas we hit:
‚Ä¢	RHEL9 module metadata problem for Node.js offline (we avoid Node offline)
‚Ä¢	Missing wheel / isa-rwval wheelhouse issues
‚Ä¢	RHEL9 subscription-manager regenerating redhat.repo offline
‚Ä¢	SELinux blocking execution from /home (we set permissive)
‚Ä¢	Running Galaxy as a service without run.sh installing requirements (direct gunicorn start + PYTHONPATH)
________________________________________
Galaxy Air-Gapped Install (RHEL 9) ‚Äì Online Build ‚Üí Offline Service
Assumptions
‚Ä¢	Online RHEL 9 VM (has internet): build + bundle creation
‚Ä¢	Offline RHEL 9 VM (air-gapped): deploy + run in service
‚Ä¢	Single transfer preferred (one tarball)
In practice, if you miss wheels you may need a tiny ‚Äúpatch‚Äù tarball.
________________________________________
0) System Requirements
Minimum practical (client build is heavy):
‚Ä¢	CPU: 4 vCPU
‚Ä¢	RAM: 16 GB (20‚Äì32 GB safer)
‚Ä¢	Disk: 150 GB minimum (more recommended)
________________________________________
1) Common Layout (both servers)
Create galaxy user:
sudo useradd -r -m -d /home/galaxy -s /bin/bash galaxy
Directory layout:
‚Ä¢	/home/galaxy/galaxy ‚Äì Galaxy source
‚Ä¢	/srv/galaxy-offline/pip ‚Äì wheelhouse (all Python wheels for offline)
‚Ä¢	/srv/galaxy-offline/rpms ‚Äì local RPM repo
‚Ä¢	/srv/gravity ‚Äì Gravity source (online only, for wheel build)
________________________________________
‚úÖ ONLINE SERVER (build system)
2) Enable RHEL repos (online)
sudo subscription-manager register
sudo subscription-manager attach --auto

sudo subscription-manager repos \
  --enable=rhel-9-for-x86_64-baseos-rpms \
  --enable=rhel-9-for-x86_64-appstream-rpms
3) Install build dependencies (online)
sudo dnf install -y \
  gcc gcc-c++ make \
  python3 python3-devel python3-pip \
  libffi-devel openssl-devel \
  bzip2-devel zlib-devel \
  sqlite sqlite-devel \
  git rsync wget curl \
  nodejs npm \
  dnf-utils createrepo_c \
  rust cargo
Verify Node:
node -v
npm -v
Install yarn (Galaxy client build needs it):
sudo npm install -g yarn
4) Clone Galaxy (online)
sudo -u galaxy bash -lc '
cd ~
git clone https://github.com/galaxyproject/galaxy.git
cd galaxy
git checkout release_24.2
'
5) Create venv + upgrade pip tooling (online)
sudo -u galaxy bash -lc '
set -e
cd /home/galaxy/galaxy
python3 -m venv .venv
.venv/bin/python -m ensurepip --upgrade || true
.venv/bin/python -m pip install --upgrade pip setuptools wheel
.venv/bin/python -m pip -V
'
6) Build the Galaxy client (UI) (online)
Important: Yarn must be in PATH for the galaxy user. If needed:
export PATH=/usr/local/bin:$PATH
sudo -u galaxy bash -lc '
set -e
cd /home/galaxy/galaxy
source .venv/bin/activate
export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
export NODE_OPTIONS="--max_old_space_size=8192"
make client-production
'
7) Build Gravity wheel (online)
Clone gravity:
sudo mkdir -p /srv
sudo chown galaxy:galaxy /srv

sudo -u galaxy bash -lc '
cd /srv
git clone https://github.com/nsoranzo/gravity.git
'
Create wheelhouse:
sudo mkdir -p /srv/galaxy-offline/pip /srv/galaxy-offline/rpms
sudo chown -R galaxy:galaxy /srv/galaxy-offline
Build gravity wheel:
sudo -u galaxy bash -lc '
set -e
source /home/galaxy/galaxy/.venv/bin/activate
pip wheel --no-deps -w /srv/galaxy-offline/pip /srv/gravity
ls -lh /srv/galaxy-offline/pip | egrep "gravity-.*whl"
'
8) Download Python requirements into wheelhouse (online)
sudo -u galaxy bash -lc '
set -e
cd /home/galaxy/galaxy
source .venv/bin/activate
export PYTHONNOUSERSITE=1
pip download -r requirements.txt --dest /srv/galaxy-offline/pip
'
Critical add-ons (avoid offline failure)
We hit these in real life. Add them now:
sudo -u galaxy bash -lc '
set -e
source /home/galaxy/galaxy/.venv/bin/activate
pip download --dest /srv/galaxy-offline/pip wheel
pip wheel -w /srv/galaxy-offline/pip isa-rwval==0.10.11
ls -lh /srv/galaxy-offline/pip | egrep "wheel-|isa[_-]rwval"
'
9) Download RPMs into local repo (online)
Note: Node/npm RPMs are modular on RHEL9. Offline modular metadata is painful.
Offline server does not need nodejs/npm (client already built), so don‚Äôt bother including nodejs RPMs unless you plan to handle module metadata.
sudo dnf download --resolve \
  gcc gcc-c++ make \
  python3 python3-devel python3-pip \
  libffi-devel openssl-devel \
  bzip2-devel zlib-devel \
  sqlite sqlite-devel \
  git rsync wget curl \
  policycoreutils-python-utils \
  --destdir /srv/galaxy-offline/rpms

sudo createrepo_c /srv/galaxy-offline/rpms
10) Create single transfer tarball (online)
sudo tar czf /root/galaxy-airgap-bundle.tar.gz \
  /home/galaxy/galaxy \
  /srv/galaxy-offline
ls -lh /root/galaxy-airgap-bundle.tar.gz
Transfer /root/galaxy-airgap-bundle.tar.gz to the offline server.
________________________________________
üîí OFFLINE SERVER (air-gapped)
11) Create galaxy user (offline)
sudo useradd -r -m -d /home/galaxy -s /bin/bash galaxy
12) Extract bundle (offline)
sudo tar xzf /root/galaxy-airgap-bundle.tar.gz -C /
sudo chown -R galaxy:galaxy /home/galaxy /srv/galaxy-offline
Verify:
ls -ld /home/galaxy/galaxy
ls -l /srv/galaxy-offline
________________________________________
13) Configure offline-only DNF repo (offline)
Create local repo file:
sudo tee /etc/yum.repos.d/galaxy-offline.repo <<EOF
[galaxy-offline]
name=Galaxy Offline Repo
baseurl=file:///srv/galaxy-offline/rpms
enabled=1
gpgcheck=0
EOF
CRITICAL: Stop subscription-manager from regenerating redhat.repo
Disable the plugin (this is what finally worked):
sudo sed -i 's/^enabled=.*/enabled=0/' /etc/dnf/plugins/subscription-manager.conf
Remove redhat repo file(s):
sudo rm -f /etc/yum.repos.d/redhat.repo
Cache only offline:
sudo dnf clean all
sudo dnf makecache --disablerepo="*" --enablerepo="galaxy-offline"
dnf repolist
Expected: only galaxy-offline
________________________________________
14) Install OS packages (offline)
Do NOT install nodejs/npm offline (modular metadata problem).
sudo dnf install -y \
  gcc gcc-c++ make \
  python3 python3-devel python3-pip \
  libffi-devel openssl-devel \
  bzip2-devel zlib-devel \
  sqlite sqlite-devel \
  git rsync wget curl \
  policycoreutils-python-utils \
  --disablerepo="*" --enablerepo="galaxy-offline"
________________________________________
15) Configure pip offline (offline)
sudo mkdir -p /home/galaxy/.config/pip
sudo tee /home/galaxy/.config/pip/pip.conf <<EOF
[global]
no-index = true
find-links = file:///srv/galaxy-offline/pip
disable-pip-version-check = true
EOF
sudo chown -R galaxy:galaxy /home/galaxy/.config
________________________________________
16) Create venv + install requirements from wheelhouse (offline)
sudo -u galaxy bash -lc '
set -e
cd /home/galaxy/galaxy
rm -rf .venv
python3 -m venv .venv

# Ensure wheel exists and is installable offline
.venv/bin/python -m pip install --no-index --find-links=file:///srv/galaxy-offline/pip wheel setuptools

# Install gravity + requirements
.venv/bin/python -m pip install --no-index --find-links=file:///srv/galaxy-offline/pip --force-reinstall --no-deps gravity==1.1.1
.venv/bin/python -m pip install --no-index --find-links=file:///srv/galaxy-offline/pip -r requirements.txt

# verify
.venv/bin/python -m pip show gravity
.venv/bin/python -m pip show isa-rwval
'
________________________________________
17) Create Galaxy config (offline)
sudo -u galaxy bash -lc '
cd /home/galaxy/galaxy
cp config/galaxy.yml.sample config/galaxy.yml
'
Edit:
sudo vi /home/galaxy/galaxy/config/galaxy.yml
Minimum:
server:
  host: 0.0.0.0
  port: 8080

galaxy_user: galaxy
________________________________________
18) SELinux (offline) ‚Äì Make it work reliably
We hit SELinux blocking execution of venv binaries from /home.
Fast, practical solution: set permissive.
Temporary:
sudo setenforce 0
getenforce
Permanent:
sudo vi /etc/selinux/config
# set:
SELINUX=permissive
(Reboot later.)
________________________________________
‚úÖ 19) Run Galaxy as a systemd service (offline) ‚Äì NO run.sh installs
This is the final working approach:
‚Ä¢	Start gunicorn directly
‚Ä¢	Ensure PYTHONPATH points to Galaxy source lib/ so import galaxy works
‚Ä¢	Avoid run.sh dependency re-installs (which triggered isa-rwval ‚Äúunavailable‚Äù)
Create service:
sudo tee /etc/systemd/system/galaxy.service <<'EOF'
[Unit]
Description=Galaxy Server
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=galaxy
Group=galaxy
WorkingDirectory=/home/galaxy/galaxy

Environment=PATH=/home/galaxy/galaxy/.venv/bin:/usr/bin:/bin
Environment=GALAXY_CONFIG_FILE=/home/galaxy/galaxy/config/galaxy.yml
Environment=PYTHONPATH=/home/galaxy/galaxy/lib

ExecStart=/usr/bin/bash -lc 'cd /home/galaxy/galaxy && export PYTHONPATH=/home/galaxy/galaxy/lib && source .venv/bin/activate && exec gunicorn -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8080 --workers 2 --timeout 300 galaxy.webapps.galaxy.fast_factory:factory'

Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
Enable and start:
sudo systemctl daemon-reload
sudo systemctl enable --now galaxy
systemctl status galaxy --no-pager
Verify listener:
ss -tulpen | grep 8080
Open in browser:
‚Ä¢	http://<offline-server-ip>:8080
If firewalld enabled:
sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload
Logs:
journalctl -u galaxy -n 120 --no-pager
________________________________________
Troubleshooting Cheatsheet
DNF still shows BaseOS/AppStream offline
‚Ä¢	subscription-manager plugin is still enabled
Fix:
sudo sed -i 's/^enabled=.*/enabled=0/' /etc/dnf/plugins/subscription-manager.conf
sudo rm -f /etc/yum.repos.d/redhat.repo
Offline Node/npm install fails (‚ÄúNo available modular metadata‚Äù)
‚Ä¢	Don‚Äôt install nodejs offline; build client online only.
isa-rwval (unavailable) during offline pip install
‚Ä¢	Ensure you built isa-rwval wheel online:
pip wheel -w /srv/galaxy-offline/pip isa-rwval==0.10.11
systemd 203/EXEC / Permission denied from venv
‚Ä¢	SELinux blocking execution under /home (very common)
Fix: permissive:
sudo setenforce 0
ModuleNotFoundError: No module named 'galaxy' in gunicorn
‚Ä¢	Missing PYTHONPATH=/home/galaxy/galaxy/lib (required)


FULL GALAXY config file in the end
[Unit]
Description=Galaxy Server
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=galaxy
Group=galaxy
WorkingDirectory=/home/galaxy/galaxy
Environment=PATH=/home/galaxy/galaxy/.venv/bin:/usr/bin:/bin
Environment=GALAXY_CONFIG_FILE=/home/galaxy/galaxy/config/galaxy.yml
#Environment=PYTHONPATH=/home/galaxy/galaxy
Environment=PYTHONPATH=/home/galaxy/galaxy/lib

#ExecStart=/usr/bin/bash -lc 'cd /home/galaxy/galaxy && source .venv/bin/activate && exec gunicorn -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8080>

#ExecStart=/usr/bin/bash -lc 'cd /home/galaxy/galaxy && export PYTHONPATH=/home/galaxy/galaxy && source .venv/bin/activate && exec gunicorn -k uvic>
ExecStart=/usr/bin/bash -lc 'cd /home/galaxy/galaxy && export PYTHONPATH=/home/galaxy/galaxy/lib && source .venv/bin/activate && exec gunicorn -k u>

Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target


Clear old files away
PART 0 ‚Äî Clean slate (optional but recommended on the online VM)
If you want a clean test run on the online VM:
sudo rm -rf /srv/galaxy-offline /root/galaxy-src /home/galaxy/galaxy /root/galaxy-airgap-bundle.tar.gz
sudo userdel -r galaxy 2>/dev/null || true


Disable SELinux

sudo setenforce 0

Permanent fix (recommended if this is a dedicated Galaxy box)
Edit the SELinux config:
sudo vi /etc/selinux/config
Change:
SELINUX=enforcing
to:
SELINUX=permissive
Save and reboot when convenient:
sudo reboot
After reboot:
getenforce
Should still show:
Permissive
Galaxy will continue working under systemd without SELinux blocking your venv.

